function PostSlack($malware_name, $user_name, $path){
  $webhook = "{{ webhook_url }}"
  $ip = ([Net.Dns]::GetHostAddresses('').IPAddressToString | select-string -notmatch ":" | %{$_.line})
  $date = (Get-Date)
  $payload = @{ 
    username = "malware alert";
    icon_emoji = ":imp:";
    attachments = @(@{
      pretext = "${malware_name} was detected";
      color = "#D00000";
      fields = @(
        @{
          title = "Name";
          value = "${malware_name}";
        },@{
          title = "User";
          value = "${user_name}";
          short = "true";
        },@{
          title = "Host";
          value = $Env:COMPUTERNAME;
          short = "true";
        },@{
          title = "IP";
          value = "${ip}";
          short = "true";
        },@{
          title = "Date";
          value = "${date}";
          short = "true";
        },@{
          title = "Path";
          value = "${path}";
        });
    });
  }
  $json = ConvertTo-Json -Depth 100 $payload
  $body = [System.Text.Encoding]::UTF8.GetBytes($json)
  Invoke-RestMethod -Uri $webhook -Method Post -Body $body
}


$last_log_date = get-date
$last_detection_id = ""
while (1) {
  $events = (get-winevent -LogName "Microsoft-Windows-Windows Defender/Operational" | where-object {$_.Id -ge 1006 -and $_.Id -le 1120 -and $_.TimeCreated -gt $last_log_date} )

  for($i = 0; $i -lt $events.Count; $i++){
    $event = [xml]$events[$i].ToXml()
    $detection_id = ($event.Event.EventData.Data | ? {$_.Name -eq "Detection ID"}).'#text'
    Write-Host ($last_detection_id)
    Write-Host ($detection_id)
    if ($last_detection_id -eq $detection_id) {
      continue
    }
    $last_detection_id = $detection_id
    $threat_id = ($event.Event.EventData.Data | ? {$_.Name -eq "Threat ID"}).'#text'
    $threat_name = ($event.Event.EventData.Data | ? {$_.Name -eq "Threat Name"}).'#text'
    $user_name = ($event.Event.EventData.Data | ? {$_.Name -eq "Detection User"}).'#text'
    $path = ($event.Event.EventData.Data | ? {$_.Name -eq "Path"}).'#text'
    Write-Host ($threat_name)
    if([string]::IsNullOrEmpty($threat_name)) {
      continue
    }
    PostSlack $threat_name $user_name $path
    $time_created = $events[$i].TimeCreated
    if ($time_created -gt $last_log_date) {
      $last_log_date = $time_created
    }
  }
  Start-Sleep -s 60
}
